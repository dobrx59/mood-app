<!DOCTYPE html>
<html lang="fr" style="background-color: #f2f2f7;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MoodApp">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3069/3069172.png">
    
    <title>Mood Tracker</title>
    <style>
        :root {
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        html, body { 
            margin: 0; padding: 0; 
            width: 100%; height: 100%;
            background-color: #f2f2f7;
            font-family: -apple-system, sans-serif; 
            overflow: hidden; 
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .cache { display: none !important; }

        /* √âCRAN DE CHOIX - LES BOUTONS COULENT JUSQU'EN BAS */
        #ecran-choix {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
        }

        .bouton-principal { 
            flex: 1; 
            width: 100%; 
            border: none; 
            font-size: 100px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer;
            padding-top: 0;
            padding-bottom: 0;
        }

        /* Le bouton du bas (rouge) prend le padding de la barre iPhone pour que l'emoji reste centr√© visuellement */
        .bouton-principal.rouge { 
            background-color: #FF8B94; 
            padding-bottom: var(--safe-bottom); 
        }
        .bouton-principal.vert { 
            background-color: #A8E6CF; 
            padding-top: var(--safe-top); 
        }

        /* AUTRES √âCRANS */
        .ecran-accueil { display: flex; flex-direction: column; height: 100vh; width: 100%; position: relative; align-items: center; justify-content: center; }
        
        .fleche-retour { position: absolute; top: calc(var(--safe-top) + 15px); left: 20px; font-size: 30px; color: #8e8e93; z-index: 10; }
        #titre-raison { margin-top: calc(var(--safe-top) + 20px); }
        .actions-finales { display: flex; gap: 10px; margin-bottom: 20px; margin-top: calc(var(--safe-top) + 20px); }

        #ecran-confirmation { padding-bottom: var(--safe-bottom); }

        .liste-raisons { display: flex; flex-direction: column; width: 85%; max-width: 350px; gap: 10px; margin-bottom: 15px; }
        .item-cause { display: flex; gap: 8px; width: 100%; }
        .btn-raison { flex: 1; padding: 18px; border: none; border-radius: 15px; background: white; font-size: 17px; font-weight: 600; text-align: left; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn-suppr { background: white; border: none; border-radius: 15px; padding: 0 15px; color: #FF8B94; font-weight: bold; }

        .zone-ajout { display: flex; width: 85%; max-width: 350px; gap: 10px; }
        #input-nouvelle-cause { flex: 1; padding: 15px; border-radius: 12px; border: 1px solid #ddd; outline: none; font-size: 16px; }
        #btn-ajouter-cause { padding: 15px; background: white; border: none; border-radius: 12px; font-weight: bold; }

        .bouton-onglet { border: none; padding: 12px 20px; border-radius: 20px; font-size: 14px; font-weight: bold; background: #e5e5ea; color: #8e8e93; }
        .actif-vert { background-color: #A8E6CF !important; color: #3d7a63 !important; }
        .actif-rouge { background-color: #FF8B94 !important; color: #8a3d43 !important; }

        .grille { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; background: white; padding: 20px; border-radius: 25px; }
        .pixel { width: 35px; height: 35px; background: #eee; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; }
        .pixel.vert { background-color: #A8E6CF !important; }
        .pixel.rouge { background-color: #FF8B94 !important; }

        .stats-container { width: 85%; max-width: 350px; }
        .stat-card { background: white; padding: 20px; border-radius: 20px; margin-bottom: 10px; text-align: left; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .stat-label { font-size: 10px; color: #999; text-transform: uppercase; display: block; }
        .stat-valeur { font-size: 18px; font-weight: bold; color: #333; }

        .btn-reset { margin-top: 20px; font-size: 12px; color: #ccaeae; text-decoration: underline; padding-bottom: 30px; }

        #splash-screen { position: fixed; inset: 0; background-color: #ffffff; display: flex; align-items: center; justify-content: center; z-index: 5000; }
        .hidden-splash { opacity: 0 !important; pointer-events: none; transition: opacity 1s ease-out; }
    </style>
</head>
<body>

<div id="app">
    <div id="splash-screen">
        <div class="carte-accueil">Alors, ton ressenti du jour ?</div>
    </div>

    <div id="ecran-choix">
        <button class="bouton-principal vert" onclick="choisirHumeur('content')">üòä</button>
        <button class="bouton-principal rouge" onclick="choisirHumeur('pas-content')">üòï</button>
    </div>

    <div id="ecran-raisons" class="ecran-accueil cache">
        <div class="fleche-retour" onclick="naviguer('ecran-choix')">‚Üê</div>
        <h1 id="titre-raison">Pourquoi ?</h1>
        <div id="container-raisons" class="liste-raisons"></div>
        <div class="zone-ajout">
            <input type="text" id="input-nouvelle-cause" placeholder="Ajouter..." maxlength="25">
            <button id="btn-ajouter-cause">+</button>
        </div>
    </div>

    <div id="modal-note" class="modal cache" style="position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 6000;">
        <div class="modal-content" style="background: white; padding: 30px; border-radius: 30px; width: 80%; max-width: 400px; text-align: center;">
            <h3 style="margin-top:0;">Une pr√©cision ?</h3>
            <textarea id="input-note" placeholder="Tape ici..." rows="4" style="width:100%; border-radius:15px; border:1px solid #ddd; padding:10px; outline:none; resize:none; margin-bottom:15px; box-sizing: border-box;"></textarea>
            <button id="btn-valider-note" class="bouton-onglet" style="width:100%; background:#A8E6CF; color:#3d7a63; padding:15px; border-radius:20px; border:none; font-weight:bold;">Terminer ‚ú®</button>
        </div>
    </div>

    <div id="ecran-confirmation" class="ecran-accueil cache">
        <div class="fleche-retour" onclick="naviguer('ecran-raisons')">‚Üê</div>
        <div class="actions-finales">
            <button id="btn-voir-grille" class="bouton-onglet">Calendrier</button>
            <button id="btn-voir-stats" class="bouton-onglet">Analyses üìä</button>
        </div>
        <h2 id="nom-du-mois" style="margin: 10px 0;"></h2>
        <div id="grille-pixels" class="grille"></div>
        <div id="section-stats" class="stats-container cache">
            <div class="stat-card">
                <span class="stat-label">Humeur moyenne</span>
                <span id="score-bonheur" class="stat-valeur">--</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Source principale</span>
                <span id="cause-majeure" class="stat-valeur">--</span>
            </div>
        </div>
        <p class="btn-reset" onclick="resetData()">R√©initialiser tout le mois</p>
    </div>

    <div id="modal-detail" class="modal cache" style="position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 6000;">
        <div class="modal-content" style="background: white; padding: 30px; border-radius: 30px; width: 80%; max-width: 400px; text-align: center;">
            <div id="modal-emoji" style="font-size: 50px;">üòä</div>
            <h2 id="modal-date" style="font-size: 16px; color: #888;">Date</h2>
            <div id="modal-raison" style="font-size: 22px; font-weight: bold; margin: 15px 0;">Raison</div>
            <button onclick="document.getElementById('modal-detail').classList.add('cache')" class="bouton-onglet" style="width: 100%; background: #eee; border:none; padding:15px; border-radius:20px;">Fermer</button>
        </div>
    </div>
</div>

<script type="module">
    import confetti from "https://cdn.skypack.dev/canvas-confetti";

    let humeurDuJour = "";
    let causeChoisie = ""; 
    const date = new Date();
    const idMois = `${date.getFullYear()}-${date.getMonth()}`;
    let mesCauses = JSON.parse(localStorage.getItem('mesCauses')) || ["üè¢ Travail", "‚ù§Ô∏è Amour", "ü•ó Sant√©", "üéÆ Loisirs"];

    setTimeout(() => {
        const splash = document.getElementById('splash-screen');
        if(splash) splash.classList.add('hidden-splash');
    }, 1500);

    window.naviguer = function(id) {
        document.querySelectorAll('#ecran-choix, .ecran-accueil').forEach(e => e.classList.add('cache'));
        document.getElementById(id).classList.remove('cache');
    }

    window.choisirHumeur = function(h) {
        humeurDuJour = h;
        confetti({ particleCount: 40, colors: h === 'content' ? ['#A8E6CF'] : ['#FF8B94'] });
        naviguer('ecran-raisons');
        document.getElementById('titre-raison').innerText = h === 'content' ? "Super ! Pourquoi ?" : "Mince... Pourquoi ?";
        chargerCauses();
    }

    function chargerCauses() {
        const cont = document.getElementById('container-raisons');
        cont.innerHTML = "";
        mesCauses.forEach((r, index) => {
            const div = document.createElement('div');
            div.className = "item-cause";
            div.innerHTML = `<button class="btn-raison">${r}</button><button class="btn-suppr">√ó</button>`;
            div.querySelector('.btn-raison').onclick = () => {
                causeChoisie = r;
                document.getElementById('modal-note').classList.remove('cache');
            };
            div.querySelector('.btn-suppr').onclick = () => {
                mesCauses.splice(index, 1);
                localStorage.setItem('mesCauses', JSON.stringify(mesCauses));
                chargerCauses();
            };
            cont.appendChild(div);
        });
    }

    document.getElementById('btn-valider-note').onclick = () => {
        const noteDetail = document.getElementById('input-note').value; 
        const histo = JSON.parse(localStorage.getItem(`histo-${idMois}`)) || {};
        histo[date.getDate()] = { humeur: humeurDuJour, raison: causeChoisie, note: noteDetail };
        localStorage.setItem(`histo-${idMois}`, JSON.stringify(histo));
        document.getElementById('modal-note').classList.add('cache');
        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        afficherFinal();
    };

    function afficherFinal() {
        naviguer('ecran-confirmation');
        document.getElementById('nom-du-mois').innerText = date.toLocaleDateString('fr-FR', {month:'long'});
        dessinerGrille();
        calculerStats();
        MAJOnglets('btn-voir-grille');
    }

    function dessinerGrille() {
        const grille = document.getElementById('grille-pixels');
        grille.innerHTML = "";
        const histo = JSON.parse(localStorage.getItem(`histo-${idMois}`)) || {};
        const nbJours = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
        for(let i=1; i<=nbJours; i++) {
            const p = document.createElement('div');
            p.className = "pixel " + (histo[i] ? (histo[i].humeur === 'content' ? 'vert' : 'rouge') : '');
            p.innerText = i;
            if(histo[i]) {
                p.onclick = () => {
                    document.getElementById('modal-emoji').innerText = histo[i].humeur === 'content' ? 'üòä' : 'üòï';
                    document.getElementById('modal-date').innerText = "Le " + i;
                    document.getElementById('modal-raison').innerHTML = histo[i].raison + (histo[i].note ? `<br><small style="font-weight:normal; font-style:italic;">"${histo[i].note}"</small>` : "");
                    document.getElementById('modal-detail').classList.remove('cache');
                };
            }
            grille.appendChild(p);
        }
    }

    function calculerStats() {
        const histo = JSON.parse(localStorage.getItem(`histo-${idMois}`)) || {};
        const jours = Object.values(histo);
        if(jours.length === 0) return;
        const positifs = jours.filter(j => j.humeur === 'content').length;
        document.getElementById('score-bonheur').innerText = Math.round((positifs / jours.length) * 100) + "% positif";
        const counts = {};
        jours.forEach(j => counts[j.raison] = (counts[j.raison] || 0) + 1);
        const top = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
        document.getElementById('cause-majeure').innerText = top;
    }

    function MAJOnglets(idBouton) {
        document.querySelectorAll('.bouton-onglet').forEach(b => b.classList.remove('actif-vert', 'actif-rouge'));
        document.getElementById(idBouton).classList.add(humeurDuJour === 'content' ? 'actif-vert' : 'actif-rouge');
    }

    document.getElementById('btn-voir-grille').onclick = () => {
        MAJOnglets('btn-voir-grille');
        document.getElementById('grille-pixels').classList.remove('cache');
        document.getElementById('nom-du-mois').classList.remove('cache');
        document.getElementById('section-stats').classList.add('cache');
    };

    document.getElementById('btn-voir-stats').onclick = () => {
        MAJOnglets('btn-voir-stats');
        document.getElementById('section-stats').classList.remove('cache');
        document.getElementById('grille-pixels').classList.add('cache');
        document.getElementById('nom-du-mois').classList.add('cache');
    };

    window.resetData = function() {
        if(confirm("Effacer tout le mois ?")) { localStorage.removeItem(`histo-${idMois}`); location.reload(); }
    };

    document.getElementById('btn-ajouter-cause').onclick = () => {
        const val = document.getElementById('input-nouvelle-cause').value;
        if(val.trim()) { mesCauses.push(val.trim()); localStorage.setItem('mesCauses', JSON.stringify(mesCauses)); chargerCauses(); document.getElementById('input-nouvelle-cause').value = ""; }
    };

    const histoInit = JSON.parse(localStorage.getItem(`histo-${idMois}`)) || {};
    if(histoInit[date.getDate()]) {
        humeurDuJour = histoInit[date.getDate()].humeur;
        document.getElementById('splash-screen').style.display = 'none';
        afficherFinal();
    }
</script>
</body>
</html>
